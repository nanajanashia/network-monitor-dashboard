<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Monitor Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .record-note {
            font-size: 13px;
            color: #999;
        }

        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            background: #f8f9fa;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        tr.new-row {
            animation: highlight 2s ease-out;
        }

        @keyframes highlight {
            from { background-color: #fef3c7; }
            to { background-color: transparent; }
        }

        .malicious { color: #ef4444; font-weight: 600; }
        .suspicious { color: #f59e0b; font-weight: 600; }
        .harmless { color: #22c55e; }
        .undetected { color: #6b7280; }

        .ip {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }

        .timestamp {
            color: #888;
            font-size: 12px;
        }

        .count {
            display: inline-block;
            min-width: 30px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Network Monitor Dashboard</h1>
        <span class="record-note">Showing last 1,000 records</span>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Source IP</th>
                    <th>Destination IP</th>
                    <th>Protocol</th>
                    <th>TTL</th>
                    <th>Flags</th>
                    <th>Length</th>
                    <th>Malicious</th>
                    <th>Suspicious</th>
                    <th>Harmless</th>
                    <th>Undetected</th>
                    <th>Scan Date</th>
                    <th>Checked At</th>
                </tr>
            </thead>
            <tbody id="packetTable">
                {{range .}}
                <tr data-id="{{.ID}}">
                    <td>{{.ID}}</td>
                    <td class="ip">{{.SourceIP}}</td>
                    <td class="ip">{{.DestinationIP}}</td>
                    <td>{{.Protocol}}</td>
                    <td>{{.TTL}}</td>
                    <td>{{.Flags}}</td>
                    <td>{{.TotalLength}}</td>
                    <td>{{if gt .Malicious 0}}<span class="malicious count">{{.Malicious}}</span>{{else}}<span class="count">{{.Malicious}}</span>{{end}}</td>
                    <td>{{if gt .Suspicious 0}}<span class="suspicious count">{{.Suspicious}}</span>{{else}}<span class="count">{{.Suspicious}}</span>{{end}}</td>
                    <td><span class="harmless count">{{.Harmless}}</span></td>
                    <td><span class="undetected count">{{.Undetected}}</span></td>
                    <td>{{.ScanDate}}</td>
                    <td class="timestamp">{{.CheckedAt.Format "2006-01-02 15:04:05"}}</td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>

    <script>
        const MAX_ROWS = 1000;
        let lastId = getLastId();

        function getLastId() {
            const firstRow = document.querySelector('#packetTable tr');
            return firstRow ? parseInt(firstRow.dataset.id) : 0;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleString('sv-SE').replace('T', ' ').slice(0, 19);
        }

        function createRow(packet) {
            const tr = document.createElement('tr');
            tr.dataset.id = packet.id;
            tr.className = 'new-row';

            const maliciousClass = packet.malicious > 0 ? 'malicious' : '';
            const suspiciousClass = packet.suspicious > 0 ? 'suspicious' : '';

            tr.innerHTML = `
                <td>${packet.id}</td>
                <td class="ip">${packet.source_ip}</td>
                <td class="ip">${packet.destination_ip}</td>
                <td>${packet.protocol}</td>
                <td>${packet.ttl}</td>
                <td>${packet.flags || ''}</td>
                <td>${packet.total_length}</td>
                <td><span class="${maliciousClass} count">${packet.malicious}</span></td>
                <td><span class="${suspiciousClass} count">${packet.suspicious}</span></td>
                <td><span class="harmless count">${packet.harmless}</span></td>
                <td><span class="undetected count">${packet.undetected}</span></td>
                <td>${packet.scan_date || ''}</td>
                <td class="timestamp">${formatDate(packet.checked_at)}</td>
            `;

            return tr;
        }

        async function fetchNewPackets() {
            try {
                const response = await fetch(`/api/packets?after_id=${lastId}`);
                const packets = await response.json();

                if (packets && packets.length > 0) {
                    const tbody = document.getElementById('packetTable');

                    packets.forEach(packet => {
                        const newRow = createRow(packet);
                        tbody.insertBefore(newRow, tbody.firstChild);
                    });

                    lastId = packets[0].id;

                    while (tbody.children.length > MAX_ROWS) {
                        tbody.removeChild(tbody.lastChild);
                    }
                }
            } catch (err) {
                console.error('Error fetching packets:', err);
            }
        }

        setInterval(fetchNewPackets, 1000);
    </script>
</body>
</html>
